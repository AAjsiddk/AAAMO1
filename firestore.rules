/**
 * @fileoverview Firestore Security Rules for Smart Personal World.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model.  All data is nested under
 * /users/{userId}, ensuring that users can only access their own data.  This
 * design prioritizes data isolation and straightforward security rules.
 *
 * Data Structure:
 * The data is organized hierarchically:
 * - /users/{userId}: Stores user profile information.
 * - /users/{userId}/files/{fileId}: Stores files uploaded by the user.
 * - /users/{userId}/audit_logs/{auditLogId}: Stores audit logs for the user.
 * - /users/{userId}/journalEntries/{journalEntryId}: Stores journal entries for the user.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Defines the `isOwner(userId)` helper function.
     * @principle Checks if the request is made by the owner of the resource.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Defines the `isExistingOwner(userId)` helper function.
     * @principle Combines the ownership check with the existence check.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId));
    }

    /**
     * @description Security rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) User 'alice' (auth.uid: 'alice') can create their own profile with matching ID.
     * @deny (create) User 'bob' (auth.uid: 'bob') cannot create a profile for 'alice'.
     * @allow (get) User 'alice' (auth.uid: 'alice') can read their own profile.
     * @deny (get) User 'bob' (auth.uid: 'bob') cannot read 'alice's profile.
     * @principle Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Security rules for the /users/{userId}/tasks/{taskId} collection.
     * @path /users/{userId}/tasks/{taskId}
     * @principle Enforces user-ownership for tasks.
     */
    match /users/{userId}/tasks/{taskId} {
      allow read, write, create, update, delete: if isOwner(userId);
      allow list: if isOwner(userId);
    }

    /**
     * @description Security rules for the /users/{userId}/files/{fileId} collection.
     * @path /users/{userId}/files/{fileId}
     * @allow (create) User 'alice' (auth.uid: 'alice') can create a file under their profile with matching userId.
     * @deny (create) User 'bob' (auth.uid: 'bob') cannot create a file under 'alice's profile.
     * @allow (get) User 'alice' (auth.uid: 'alice') can read a file under their profile.
     * @deny (get) User 'bob' (auth.uid: 'bob') cannot read a file under 'alice's profile.
     * @principle Enforces user-ownership for file data.
     */
    match /users/{userId}/files/{fileId} {
      allow read, write, create, update, delete: if isOwner(userId);
       allow list: if isOwner(userId);
    }
    
    /**
     * @description Security rules for the /users/{userId}/journalEntries/{journalEntryId} collection.
     * @path /users/{userId}/journalEntries/{journalEntryId}
     * @principle Enforces user-ownership for journal entries.
     */
    match /users/{userId}/journalEntries/{journalEntryId} {
      allow read, write, create, update, delete: if isOwner(userId);
       allow list: if isOwner(userId);
    }
    
     /**
     * @description Security rules for the /users/{userId}/notes/{noteId} collection.
     * @path /users/{userId}/notes/{noteId}
     * @principle Enforces user-ownership for notes.
     */
    match /users/{userId}/notes/{noteId} {
      allow read, write, create, update, delete: if isOwner(userId);
       allow list: if isOwner(userId);
    }

    /**
     * @description Security rules for the /users/{userId}/audit_logs/{auditLogId} collection.
     * @path /users/{userId}/audit_logs/{auditLogId}
     * @principle Enforces user-ownership for audit log data.
     */
    match /users/{userId}/audit_logs/{auditLogId} {
      allow read, write, create, update, delete: if isOwner(userId);
      allow list: if isOwner(userId);
    }
    
    match /users/{userId}/futureMessages/{messageId} {
      allow read, write, create, update, delete: if isOwner(userId);
      allow list: if isOwner(userId);
    }
    
    match /users/{userId}/libraryItems/{itemId} {
       allow read, write, create, update, delete: if isOwner(userId);
       allow list: if isOwner(userId);
    }

    match /users/{userId}/worshipActs/{actId} {
       allow read, write, create, update, delete: if isOwner(userId);
       allow list: if isOwner(userId);
    }

    match /users/{userId}/relaxationActivities/{activityId} {
        allow read, write, create, update, delete: if isOwner(userId);
        allow list: if isOwner(userId);
    }

    match /users/{userId}/goals/{goalId} {
        allow read, write, create, update, delete: if isOwner(userId);
        allow list: if isOwner(userId);
    }

    match /users/{userId}/folders/{folderId} {
        allow read, write, create, update, delete: if isOwner(userId);
        allow list: if isOwner(userId);
    }

    match /users/{userId}/habits/{habitId} {
        allow read, write, create, update, delete: if isOwner(userId);
        allow list: if isOwner(userId);
    }
    
    match /users/{userId}/habits/{habitId}/marks/{markId} {
       allow read, write, create, update, delete: if isOwner(userId);
       allow list: if isOwner(userId);
    }

    match /users/{userId}/projects/{projectId} {
       allow read, write, create, update, delete: if isOwner(userId);
       allow list: if isOwner(userId);
    }
  }
}
